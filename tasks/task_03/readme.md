# Лабораторная работа 03. Kubernetes: состояние и хранение

Описание, цели, задания и критерии приёмки приведены ниже и в локальных методических материалах каталога `tasks/`.

## Описание

В этой работе студенты развёртывают stateful-приложение в Kubernetes: настройка StatefulSet, использование PersistentVolumeClaim/PersistentVolume для постоянного хранения данных, создание Headless Service для стабильных DNS-имён подов, а также реализация резервного копирования и восстановления данных с помощью Job/CronJob. Документы и примеры находятся в каталоге `tasks/task_03/`.

## Цели

* Научиться работать со StatefulSet для управления stateful-приложениями (Postgres/Redis/MinIO).
* Настроить постоянное хранилище через PVC/PV и StorageClass с динамическим провижинингом.
* Создать Headless Service для прямого доступа к подам через DNS.
* Реализовать механизм резервного копирования (backup) и восстановления (restore) данных.
* Проверить сохранность данных после перезапуска подов.

## Материалы и варианты

* [Список вариантов](./Варианты.md).
* [Методические материалы](./Лабораторная_работа_03_Методические_материалы.md)

## Задания

1. Выбрать stateful-сервис согласно варианту (Postgres, Redis или MinIO) и подготовить манифесты:
    * StatefulSet с volumeClaimTemplates для постоянного хранения данных;
    * Headless Service (clusterIP: None) для стабильных DNS-имён подов;
    * Secret для хранения паролей и конфиденциальных данных;
    * StorageClass согласно варианту (standard/fast/premium).
2. Развернуть stateful-приложение в Kubernetes:
    * Применить все манифесты и убедиться, что поды запущены и PVC создан;
    * Создать тестовые данные (таблица в Postgres, ключи в Redis, объекты в MinIO);
    * Перезапустить под и проверить, что данные сохранились.
3. Настроить резервное копирование:
    * Создать CronJob для периодического backup согласно расписанию из варианта;
    * Реализовать сохранение резервной копии (pg_dump для Postgres, redis-cli SAVE/BGSAVE для Redis, mc mirror для MinIO);
    * Сохранять backup в отдельный PVC или использовать объектное хранилище.
4. Продемонстрировать восстановление:
    * Создать Job для восстановления данных из резервной копии;
    * Показать успешное восстановление данных после их удаления.

## Артефакты (что сдаём)

* Каталог с Kubernetes-манифестами (`k8s/` или `manifests/`): StatefulSet, Service, Secret, CronJob для backup, Job для restore.
* Скрипты backup/restore (если используются как ConfigMap или встроенные в образ).
* Файл `README.md` с полным описанием:
  * Архитектура хранения и выбранные параметры;
  * Шаги деплоя и проверки работоспособности;
  * Инструкции по запуску backup и restore;
  * Скриншоты/логи, подтверждающие сохранность данных и успешное восстановление.

---

### Метаданные (что указываем)

В README (корне проекта/папке) укажите:

* ФИО (полностью)
* Группа
* № студенческого (StudentID)
* Email (учебный)
* GitHub username
* Номер варианта
* Дата выполнения
* ОС (версия), версия Docker Desktop/Engine, версия kubectl, Kind/Minikube

В Kubernetes-манифестах/аннотациях/labels укажите следующее (пример для StatefulSet/Service):

* org.bstu.student.fullname = <ФИО>
* org.bstu.student.id = <StudentID>
* org.bstu.group = <Группа>
* org.bstu.variant = <Номер варианта>
* org.bstu.course = RSIOT

В metadata разделах Helm chart / k8s manifests можно добавить лейблы для owner/slug:

* org.bstu.owner = <GitHub username>
* org.bstu.student.slug = <slug>

slug = <группа>-<StudentID>-v<вариант> (пример, feis-41-12345-v07)

<!-- START:criteria -->
## Критерии оценивания (100 баллов)

* Корректность манифестов StatefulSet, Headless Service, PVC/PV, Secret — 25
* Настройка StorageClass и динамического провижининга, работоспособность хранилища — 20
* Проверка сохранности данных после перезапуска подов (демонстрация с логами/скриншотами) — 20
* Реализация резервного копирования через CronJob (корректность расписания и скриптов) — 20
* Демонстрация восстановления данных из backup (Job для restore, логи) — 10
* Метаданные, именование, оформление README и документация — 5

<!-- END:criteria -->

<!-- START:bonuses -->
## Бонусы (+ до 10)

* Использование Helm chart или Kustomize для управления манифестами stateful-приложения.
* Сохранение backup в объектное хранилище (S3-compatible) с автоматической ротацией.
* Настройка мониторинга состояния StatefulSet и alerting при сбоях backup.
* Автоматизация процесса деплоя и тестирования через скрипты/Makefile.

<!-- END:bonuses -->

### Требования к именованию

* Kubernetes-ресурсы: префиксы в именах: db-<slug>, backup-<slug>, storage-<slug> — это облегчает поиск и очистку ресурсов.
* ENV: STU_ID, STU_GROUP, STU_VARIANT должны логироваться при старте контейнера (если применимо).
* Namespace должен быть уникальным для каждого студента: state-<slug> или аналогичный.
