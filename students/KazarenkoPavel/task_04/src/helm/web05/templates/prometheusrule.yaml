---
{{- if .Values.monitoring.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ .Values.app.name }}-alerts
  namespace: {{ .Values.app.namespace }}
  labels:
    app: {{ .Values.app.name }}
    release: monitoring
spec:
  groups:
  - name: {{ .Values.app.name }}-slo
    rules:
    - alert: HighErrorRate
      expr: |
        sum(rate({{ .Values.monitoring.metricsPrefix }}http_errors_total[15m]))
        / sum(rate({{ .Values.monitoring.metricsPrefix }}http_requests_total[15m]))
        * 100 > {{ .Values.alerting.errorRateThreshold }}
      for: 5m
      labels:
        severity: critical
        student: "{{ .Values.student.id }}"
        variant: "{{ .Values.student.variant }}"
      annotations:
        summary: "Error rate above {{ .Values.alerting.errorRateThreshold }}%"
        description: "Error rate is {{ $value }}% for application {{ .Values.app.name }}"

    - alert: HighLatency
      expr: |
        histogram_quantile(0.95,
          sum(rate({{ .Values.monitoring.metricsPrefix }}http_request_duration_seconds_bucket[5m]))
          by (le, endpoint)
        ) > {{ .Values.alerting.latencyThreshold }}
      for: 5m
      labels:
        severity: warning
        student: "{{ .Values.student.id }}"
        variant: "{{ .Values.student.variant }}"
      annotations:
        summary: "P95 latency above {{ .Values.alerting.latencyThreshold }}s"
        description: "P95 latency is {{ $value }}s for application {{ .Values.app.name }}"
{{- end }}
