# yamllint disable rule:line-length
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-scripts
  namespace: state-as63-220028-v23
  labels:
    app: postgres-backup
    org.bstu.course: "RSIOT"
    org.bstu.student.id: "220028"
    org.bstu.group: "AS-63"
    org.bstu.variant: "23"
    org.bstu.owner: "alexsandro007"
    org.bstu.student.slug: "AS63-220028-v23"
data:
  backup.sh: |
    #!/bin/bash
    set -e

    echo "=== PostgreSQL Backup Script ==="
    echo "Student ID: ${STU_ID:-220028}"
    echo "Group: ${STU_GROUP:-АС-63}"
    echo "Variant: ${STU_VARIANT:-23}"
    echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"

    DB_HOST="${POSTGRES_HOST:-db-postgres-headless}"
    DB_PORT="${POSTGRES_PORT:-5432}"
    DB_USER="${POSTGRES_USER:-admin}"
    DB_NAME="${POSTGRES_DB:-testdb}"

    BACKUP_DIR="/backups"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="${BACKUP_DIR}/backup_${TIMESTAMP}.sql.gz"

    echo "Connecting to PostgreSQL at ${DB_HOST}:${DB_PORT}..."

    until PGPASSWORD="${POSTGRES_PASSWORD}" psql -h "${DB_HOST}" -U "${DB_USER}" -d "${DB_NAME}" -c '\q'; do
      echo "Waiting for PostgreSQL..."
      sleep 2
    done

    echo "Starting backup..."
    PGPASSWORD="${POSTGRES_PASSWORD}" pg_dump -h "${DB_HOST}" -U "${DB_USER}" -d "${DB_NAME}" --no-owner --no-acl | gzip > "${BACKUP_FILE}"

    if [ -f "${BACKUP_FILE}" ]; then
      echo "✅ Backup completed: ${BACKUP_FILE} ($(du -h "${BACKUP_FILE}" | cut -f1))"
      ls -t ${BACKUP_DIR}/backup_*.sql.gz | tail -n +6 | xargs -r rm -f
    else
      echo "❌ Backup failed!"
      exit 1
    fi

  restore.sh: |
    #!/bin/bash
    set -e

    echo "=== PostgreSQL Restore Script ==="
    echo "Student ID: ${STU_ID:-220028}"
    echo "Group: ${STU_GROUP:-АС-63}"
    echo "Variant: ${STU_VARIANT:-23}"

    DB_HOST="${POSTGRES_HOST:-db-postgres-headless}"
    DB_USER="${POSTGRES_USER:-admin}"
    DB_NAME="${POSTGRES_DB:-testdb}"
    BACKUP_DIR="/backups"

    until PGPASSWORD="${POSTGRES_PASSWORD}" psql -h "${DB_HOST}" -U "${DB_USER}" -d "${DB_NAME}" -c '\q'; do
      echo "Waiting for PostgreSQL..."
      sleep 2
    done

    LATEST_BACKUP=$(ls -t ${BACKUP_DIR}/backup_*.sql.gz 2>/dev/null | head -n1)

    if [ -z "${LATEST_BACKUP}" ]; then
      echo "❌ No backup files found"
      exit 1
    fi

    echo "Restoring from: ${LATEST_BACKUP}"

    PGPASSWORD="${POSTGRES_PASSWORD}" psql -h "${DB_HOST}" -U "${DB_USER}" -d postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = '${DB_NAME}' AND pid <> pg_backend_pid();" || true
    PGPASSWORD="${POSTGRES_PASSWORD}" psql -h "${DB_HOST}" -U "${DB_USER}" -d postgres -c "DROP DATABASE IF EXISTS ${DB_NAME};"
    PGPASSWORD="${POSTGRES_PASSWORD}" psql -h "${DB_HOST}" -U "${DB_USER}" -d postgres -c "CREATE DATABASE ${DB_NAME};"
    gunzip < "${LATEST_BACKUP}" | PGPASSWORD="${POSTGRES_PASSWORD}" psql -h "${DB_HOST}" -U "${DB_USER}" -d "${DB_NAME}"

    echo "✅ Restore completed!"
