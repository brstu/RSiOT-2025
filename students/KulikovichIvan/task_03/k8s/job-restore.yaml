apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-restore
  namespace: stateful-lab
  labels:
    org.bstu.student.fullname: "Куликович Иван Сергеевич"
    org.bstu.group: "as-63"
    org.bstu.variant: "11"
spec:
  template:
    spec:
      containers:
        - name: restore
          image: postgres:16-alpine
          command:
            - /bin/sh
            - -c
            - |
              set -e
              export PGPASSWORD=${PGPASSWORD}
              BACKUP_FILE=$(ls -t /backup/backup-*.sql | head -1)
              if [ -z "${BACKUP_FILE}" ]; then
                echo "No backup file found!" >&2
                exit 1
              fi
              echo "Restoring from: ${BACKUP_FILE}"
              psql -h postgres-0.postgres.stateful-lab.svc.cluster.local -U postgres mydb < ${BACKUP_FILE}
              echo "Restore completed successfully"
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: pgpassword
          volumeMounts:
            - name: backup-storage
              mountPath: /backup
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: backup-pvc
          restartPolicy: OnFailure
  backoffLimit: 2