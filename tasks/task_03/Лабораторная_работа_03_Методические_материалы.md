# ЛР03 — Kubernetes: состояние и хранение

План
- Обзор StatefulSet, Headless Service, PVC/PV, StorageClass, backup/restore.
- Практика: деплой stateful‑сервиса (Postgres/Redis/MinIO), проверка сохранности данных, резервное копирование и восстановление.
- Варианты (24) по параметрам хранилища и расписания backup.
- Материалы для чтения и раздел по отладке.

Необходимые знания и ПО
- Кластер Kubernetes с поддержкой динамического провижининга (minikube с CSI или managed‑кластер), kubectl.

Краткая теория
- StatefulSet — управление идентичностью pod’ов (имена с индексами), упорядоченный rollout/scale.
- Headless Service (clusterIP: None) — стабильные DNS‑имена для pod’ов без балансировки.
- PVC/PV — абстракции для постоянного хранения; StorageClass определяет тип и параметры провижининга.
- Бэкап/Restore — критичны для stateful‑нагрузок: реализуются через Job/CronJob и утилиты (pg_dump / redis-cli / скрипты).

Практика
1) Выбор сервиса
   - Вариант Postgres/Redis/MinIO. Для Postgres — образ bitnami/postgresql или официальный; для Redis — bitnami/redis или официальный.
2) Манифесты
   - statefulset.yaml

     ```yaml
     apiVersion: apps/v1
     kind: StatefulSet
     metadata:
       name: db
       namespace: state01
     spec:
       serviceName: db
       replicas: 1
       selector:
         matchLabels:
           app: db
       template:
         metadata:
           labels:
             app: db
         spec:
           containers:
             - name: db
               image: postgres:16
               ports:
                 - containerPort: 5432
               env:
                 - name: POSTGRES_PASSWORD
                   valueFrom:
                     secretKeyRef:
                       name: db-secret
                       key: password
               volumeMounts:
                 - name: data
                   mountPath: /var/lib/postgresql/data
       volumeClaimTemplates:
         - metadata:
             name: data
           spec:
             accessModes: ["ReadWriteOnce"]
             storageClassName: standard
             resources:
               requests:
                 storage: 2Gi
     ```

   - headless service: service.yaml

     ```yaml
     apiVersion: v1
     kind: Service
     metadata:
       name: db
       namespace: state01
     spec:
       clusterIP: None
       selector:
         app: db
       ports:
         - port: 5432
     ```

   - secret.yaml

     ```yaml
     apiVersion: v1
     kind: Secret
     metadata:
       name: db-secret
       namespace: state01
     type: Opaque
     stringData:
       password: examplepass
     ```

3) Проверка сохранности данных
   - Создайте таблицу/ключ, перезапустите pod и убедитесь, что данные сохранились.
4) Backup/Restore
   - Создайте CronJob, выполняющий pg_dump / redis save и сохраняющий архив в PVC или объектное хранилище. Покажите восстановление.

## Быстрый старт

Минимальные шаги (Postgres на minikube):
1. Запустите кластер: `minikube start` (при необходимости включите addons: volumesnapshots, csi-hostpath-driver).
2. Убедитесь в наличии StorageClass: `kubectl get sc` (используйте standard).
3. Примените секрет и манифесты: `kubectl apply -f secret.yaml -f service.yaml -f statefulset.yaml`.
4. Дождитесь Ready pod: `kubectl get pods -w`.
5. Создайте данные: `kubectl exec -it sts/db-0 -- psql -U postgres -c "CREATE TABLE t(id int); INSERT INTO t VALUES (1);"`.
6. Перезапустите pod: `kubectl delete pod db-0`; дождитесь восстановления и убедитесь что данные на месте.
7. Настройте CronJob backup (pg_dump) и зафиксируйте наличие файла в PVC.

Критерии приёмки
- StatefulSet работает, PVC смонтирован, данные переживают рестарт pod’а.
- Настроен и продемонстрирован Backup/Restore (скрипт/Job/CronJob). Шаги задокументированы.

Формат сдачи
- PR в основную ветку; ревьювер https://github.com/andreiNiasiuk. README: цели, архитектура хранения, шаги и скриншоты/логи.

См. варианты в файле `Варианты.md`.

Материалы для чтения
- Kubernetes Docs: StatefulSets, Volumes, Persistent Volumes, StorageClass
  - https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/
  - https://kubernetes.io/docs/concepts/storage/persistent-volumes/
  - https://kubernetes.io/docs/concepts/storage/storage-classes/
- Примеры бэкапов: официальные инструкции Postgres/Redis, K8s CronJob
  - https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/

Отладка и типичные ошибки
- PVC Pending: отсутствует подходящий StorageClass или CSI драйвер.
- Потеря данных: неверный mountPath или неиспользование volumeClaimTemplates (использован emptyDir).
- CronJob не запускается: проверьте расписание (формат crontab) и права на запись в PVC.
