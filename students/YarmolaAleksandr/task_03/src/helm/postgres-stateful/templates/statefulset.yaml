# yamllint disable rule:line-length
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{.Values.postgres.name}}
  namespace: {{.Values.namespace.name}}
  labels:
    app: {{.Values.labels.app}}
    org.bstu.course: {{.Values.labels.course | quote}}
    org.bstu.student.id: {{.Values.student.id | quote}}
    org.bstu.group: {{.Values.student.groupLatin | quote}}
    org.bstu.variant: {{.Values.student.variant | quote}}
    org.bstu.owner: {{.Values.student.owner | quote}}
    org.bstu.student.slug: {{.Values.student.slug | quote}}
  annotations:
    org.bstu.student.fullname: {{.Values.student.fullname | quote}}
spec:
  serviceName: {{.Values.service.name}}
  replicas: {{.Values.postgres.replicas}}
  selector:
    matchLabels:
      app: {{.Values.labels.app}}
  template:
    metadata:
      labels:
        app: {{.Values.labels.app}}
        org.bstu.course: {{.Values.labels.course | quote}}
        org.bstu.student.id: {{.Values.student.id | quote}}
        org.bstu.group: {{.Values.student.groupLatin | quote}}
        org.bstu.variant: {{.Values.student.variant | quote}}
        org.bstu.owner: {{.Values.student.owner | quote}}
        org.bstu.student.slug: {{.Values.student.slug | quote}}
      annotations:
        org.bstu.student.fullname: {{.Values.student.fullname | quote}}
    spec:
      containers:
        - name: postgres
          image: {{.Values.postgres.image.repository}}:{{.Values.postgres.image.tag}}
          imagePullPolicy: {{.Values.postgres.image.pullPolicy}}
          ports:
            - containerPort: {{.Values.postgres.port}}
              name: postgres
          envFrom:
            - secretRef:
                name: db-postgres-secret
          env:
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
            - name: STU_ID
              value: {{.Values.student.id | quote}}
            - name: STU_GROUP
              value: {{.Values.student.group | quote}}
            - name: STU_VARIANT
              value: {{.Values.student.variant | quote}}
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
          resources:
            {{- toYaml .Values.postgres.resources | nindent 12}}
          {{- if .Values.postgres.livenessProbe.enabled}}---
          livenessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - {{.Values.postgres.credentials.username}}
                - -d
                - {{.Values.postgres.credentials.database}}
            initialDelaySeconds: {{.Values.postgres.livenessProbe.initialDelaySeconds}}
            periodSeconds: {{.Values.postgres.livenessProbe.periodSeconds}}
          {{- end}}
          {{- if .Values.postgres.readinessProbe.enabled}}---
          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - {{.Values.postgres.credentials.username}}
                - -d
                - {{.Values.postgres.credentials.database}}
            initialDelaySeconds: {{.Values.postgres.readinessProbe.initialDelaySeconds}}
            periodSeconds: {{.Values.postgres.readinessProbe.periodSeconds}}
          {{- end}}
  volumeClaimTemplates:
    - metadata:
        name: postgres-data
        labels:
          app: {{.Values.labels.app}}
          org.bstu.student.id: {{.Values.student.id | quote}}
          org.bstu.variant: {{.Values.student.variant | quote}}
      spec:
        accessModes:
          - {{.Values.storage.data.accessMode}}
        storageClassName: {{.Values.storage.data.storageClass}}
        resources:
          requests:
            storage: {{.Values.storage.data.size}}
