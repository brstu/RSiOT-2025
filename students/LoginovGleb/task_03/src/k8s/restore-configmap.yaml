---
apiVersion: v1
kind: ConfigMap
metadata:
  name: restore-scripts-as63-220018-v14
  namespace: state-as63-220018-v14
  labels:
    org.bstu.student.fullname: "Loginov-Gleb-Olegovich"
    org.bstu.student.id: "220018"
    org.bstu.group: "AS-63"
    org.bstu.variant: "14"
    org.bstu.course: "RSIOT"
    org.bstu.owner: "gleb7499"
    org.bstu.student.slug: "AS-63-220018-v14"
data:
  restore.sh: |
    #!/bin/sh
    set -e

    echo "=== Redis Restore Script ==="
    echo "Student: Loginov Gleb Olegovich (220018)"
    echo "Group: AS-63, Variant: 14"
    echo "Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"

    BACKUP_DIR="${BACKUP_DIR:-/backup}"
    NAMESPACE="${NAMESPACE:-state-as63-220018-v14}"
    POD_NAME="${POD_NAME:-db-as63-220018-v14-0}"

    LATEST_BACKUP=$(ls -t ${BACKUP_DIR}/redis_backup_*.rdb \
      2>/dev/null | head -n 1)

    if [ -z "$LATEST_BACKUP" ]; then
      echo "ERROR: No backup files found in $BACKUP_DIR"
      exit 1
    fi

    echo "Found backup: $LATEST_BACKUP"
    echo "Backup size: $(du -h "$LATEST_BACKUP" | cut -f1)"

    echo "Copying backup to Redis data directory..."
    kubectl cp "$LATEST_BACKUP" \
      "${NAMESPACE}/${POD_NAME}:/data/dump.rdb.tmp"
    kubectl exec -n "$NAMESPACE" "$POD_NAME" -- \
      mv /data/dump.rdb.tmp /data/dump.rdb

    echo "Restarting Redis pod..."
    kubectl delete pod -n "$NAMESPACE" "$POD_NAME"

    # Дождаться готовности
    echo "Waiting for pod to be ready..."
    kubectl wait --for=condition=ready pod/"$POD_NAME" -n "$NAMESPACE" --timeout=120s

    echo "=== Restore completed successfully ==="
    exit 0
