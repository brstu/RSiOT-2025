# Makefile –¥–ª—è Lab02
# –î–ª—è Windows –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ PowerShell –∏–ª–∏ Git Bash

IMAGE_NAME := alexsandro007/rsiot-lab02
IMAGE_TAG := v1.0
NAMESPACE := app23
HOST := web23.local

.PHONY: help
help: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
	@echo "Available commands:"
	@echo "  make build         - –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑"
	@echo "  make push          - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–∑ –≤ Docker Hub"
	@echo "  make test-local    - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑ –ª–æ–∫–∞–ª—å–Ω–æ"
	@echo "  make minikube-start - –ó–∞–ø—É—Å—Ç–∏—Ç—å Minikube"
	@echo "  make deploy        - –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –≤ Kubernetes"
	@echo "  make test          - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å deployment"
	@echo "  make update        - Rolling update"
	@echo "  make logs          - –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏"
	@echo "  make clean         - –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã"
	@echo "  make all           - –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª (build + deploy)"

.PHONY: build
build: ## –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑
	docker build -t $(IMAGE_NAME):$(IMAGE_TAG) .
	@echo "Image size:"
	@docker images $(IMAGE_NAME):$(IMAGE_TAG)

.PHONY: push
push: ## –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞–∑ –≤ Docker Hub
	docker push $(IMAGE_NAME):$(IMAGE_TAG)

.PHONY: test-local
test-local: ## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑ –ª–æ–∫–∞–ª—å–Ω–æ
	docker run -d -p 8043:8043 \
		-e STU_ID=14 \
		-e STU_GROUP=–ê–°-64 \
		-e STU_VARIANT=23 \
		--name rsiot-test \
		$(IMAGE_NAME):$(IMAGE_TAG)
	@echo "Waiting for container to start..."
	@sleep 3
	@echo "Testing endpoints..."
	@curl -s http://localhost:8043/ready
	@echo ""
	@curl -s http://localhost:8043/live
	@echo ""
	@echo "Logs:"
	@docker logs rsiot-test
	@echo ""
	@echo "Cleaning up..."
	@docker stop rsiot-test
	@docker rm rsiot-test

.PHONY: minikube-start
minikube-start: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å Minikube —Å Ingress
	minikube start --driver=docker
	minikube addons enable ingress
	kubectl wait --namespace ingress-nginx \
		--for=condition=ready pod \
		--selector=app.kubernetes.io/component=controller \
		--timeout=120s
	@echo "Minikube IP: $$(minikube ip)"
	@echo "Add to hosts: $$(minikube ip) $(HOST)"

.PHONY: deploy
deploy: ## –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –≤ Kubernetes
	kubectl apply -f k8s/
	kubectl wait --namespace $(NAMESPACE) \
		--for=condition=available \
		--selector=app=web23 \
		deployment \
		--timeout=120s
	@echo "Deployment complete!"
	@kubectl get all -n $(NAMESPACE)

.PHONY: test
test: ## –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å deployment
	@echo "Testing pods..."
	@kubectl get pods -n $(NAMESPACE) -l app=web23
	@echo ""
	@echo "Testing endpoints..."
	@curl -s -o /dev/null -w "Main page: %{http_code}\n" http://$(HOST)/
	@curl -s -o /dev/null -w "Readiness: %{http_code}\n" http://$(HOST)/ready
	@curl -s -o /dev/null -w "Liveness: %{http_code}\n" http://$(HOST)/live

.PHONY: update
update: ## Rolling update
	@read -p "Enter new image tag: " TAG; \
	kubectl set image deployment/app-web23 web=$(IMAGE_NAME):$$TAG -n $(NAMESPACE)
	kubectl rollout status deployment/app-web23 -n $(NAMESPACE)
	kubectl rollout history deployment/app-web23 -n $(NAMESPACE)

.PHONY: logs
logs: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏
	kubectl logs -n $(NAMESPACE) -l app=web23 --tail=50 --all-containers=true

.PHONY: status
status: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
	@echo "=== Namespace ==="
	@kubectl get namespace $(NAMESPACE)
	@echo ""
	@echo "=== Pods ==="
	@kubectl get pods -n $(NAMESPACE)
	@echo ""
	@echo "=== Services ==="
	@kubectl get svc -n $(NAMESPACE)
	@echo ""
	@echo "=== Ingress ==="
	@kubectl get ingress -n $(NAMESPACE)
	@echo ""
	@echo "=== ConfigMap ==="
	@kubectl get configmap -n $(NAMESPACE)

.PHONY: clean
clean: ## –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã
	kubectl delete namespace $(NAMESPACE) --ignore-not-found=true
	@echo "Resources cleaned up!"

.PHONY: kustomize-dev
kustomize-dev: ## Deploy —Å Kustomize (dev –æ–∫—Ä—É–∂–µ–Ω–∏–µ)
	@echo "üöÄ Deploying with Kustomize (development)..."
	kubectl apply -k kustomize/overlays/development/
	@echo "‚úÖ Development deployment complete!"

.PHONY: kustomize-prod
kustomize-prod: ## Deploy —Å Kustomize (production –æ–∫—Ä—É–∂–µ–Ω–∏–µ)
	@echo "üöÄ Deploying with Kustomize (production)..."
	kubectl apply -k kustomize/overlays/production/
	kubectl rollout status deployment/app-web23 -n $(NAMESPACE)
	@echo "‚úÖ Production deployment complete!"

.PHONY: pvc-test
pvc-test: ## –¢–µ—Å—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
	@echo "üîç Testing PVC persistence..."
	@POD=$$(kubectl get pod -n $(NAMESPACE) -l app=web23 -o jsonpath='{.items[0].metadata.name}'); \
	echo "Writing test data to pod: $$POD"; \
	kubectl exec -n $(NAMESPACE) $$POD -- sh -c 'mkdir -p /app/data && echo "Test at $$(date)" > /app/data/test.txt'; \
	echo "Reading data..."; \
	kubectl exec -n $(NAMESPACE) $$POD -- cat /app/data/test.txt; \
	echo "Deleting pod..."; \
	kubectl delete pod -n $(NAMESPACE) $$POD; \
	echo "Waiting for new pod..."; \
	sleep 20; \
	NEW_POD=$$(kubectl get pod -n $(NAMESPACE) -l app=web23 -o jsonpath='{.items[0].metadata.name}'); \
	echo "Reading from new pod: $$NEW_POD"; \
	kubectl exec -n $(NAMESPACE) $$NEW_POD -- cat /app/data/test.txt; \
	echo "‚úÖ PVC persistence verified!"

.PHONY: all
all: build push minikube-start deploy test ## –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
	@echo "Full deployment complete!"
	@echo "Access: http://$(HOST)/"
