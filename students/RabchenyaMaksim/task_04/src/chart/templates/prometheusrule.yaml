---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{include "app39.fullname" .}}
  labels:
    prometheus: k8s
    role: alert-rules
spec:
  groups:
    - name: app39.rules
      rules:
        - alert: HighErrorRate
          expr: |
            (sum(rate({{ .Values.metrics.prefix }}
            http_requests_total{code=~"5.."}[10m]))
             / sum(rate({{ .Values.metrics.prefix }}
             http_requests_total[10m]))) > 0.01
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: >-
              High 5xx error rate for {{ .Values.metrics.prefix }}
              (>{{ .Values.alert_threshold | default "1%" }})
            description: >-
              5xx error ratio is above 1% for more than 10 minutes.

        - alert: ServiceAvailabilityLow
          expr: |
            (1 - (sum(rate({{ .Values.metrics.prefix }}
            http_requests_total{code=~"5.."}[5m]))
                  / sum(rate({{ .Values.metrics.prefix }}
                  http_requests_total[5m])))) < 0.999
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: >-
              Service availability below 99.9% for {{ .Values.metrics.prefix }}
            description: >-
              Availability (1 - 5xx ratio) dropped below 99.9% for 5 minutes.

        - alert: HighLatencyP95
          expr: |
            histogram_quantile(0.95, sum(rate({{ .Values.metrics.prefix
              }}http_request_duration_seconds_bucket[5m])) by (le)) > 0.2
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: >-
              High p95 latency (>200ms) for {{ .Values.metrics.prefix }}
            description: >-
              p95 latency exceeded 200ms for more than 5 minutes.
