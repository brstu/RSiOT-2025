apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-s3-as63-220018-v14
  namespace: state-as63-220018-v14
  labels:
    org.bstu.student.fullname: "Loginov-Gleb-Olegovich"
    org.bstu.student.id: "220018"
    org.bstu.group: "AS-63"
    org.bstu.variant: "14"
    org.bstu.course: "RSIOT"
    org.bstu.owner: "gleb7499"
    org.bstu.student.slug: "AS-63-220018-v14"
spec:
  schedule: "*/30 * * * *"  # Каждые 30 минут согласно варианту 14
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    metadata:
      labels:
        org.bstu.student.fullname: "Loginov-Gleb-Olegovich"
        org.bstu.student.id: "220018"
        org.bstu.group: "AS-63"
        org.bstu.variant: "14"
        org.bstu.course: "RSIOT"
        org.bstu.owner: "gleb7499"
        org.bstu.student.slug: "AS-63-220018-v14"
        app: redis-backup-s3
    spec:
      template:
        metadata:
          labels:
            org.bstu.student.fullname: "Loginov-Gleb-Olegovich"
            org.bstu.student.id: "220018"
            org.bstu.group: "AS-63"
            org.bstu.variant: "14"
            org.bstu.course: "RSIOT"
            org.bstu.owner: "gleb7499"
            org.bstu.student.slug: "AS-63-220018-v14"
            app: redis-backup-s3
        spec:
          restartPolicy: OnFailure
          initContainers:
          # Init container для установки redis-cli
          - name: setup-tools
            image: minio/mc:RELEASE.2024-12-13T01-47-32Z
            command:
            - /bin/sh
            - -c
            - |
              # mc уже есть в minio/mc образе
              echo "MinIO Client ready"
              mc --version
            volumeMounts:
            - name: tools
              mountPath: /tools
          containers:
          - name: redis-backup-s3
            image: minio/mc:RELEASE.2024-12-13T01-47-32Z
            command: ["/bin/sh"]
            args:
            - -c
            - |
              # Установить redis-cli
              apk add --no-cache redis
              
              # Запустить backup скрипт
              /bin/sh /scripts/backup-s3.sh
            env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-secret-as63-220018-v14
                  key: redis-password
            - name: MINIO_ROOT_USER
              valueFrom:
                secretKeyRef:
                  name: minio-secret-as63-220018-v14
                  key: root-user
            - name: MINIO_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: minio-secret-as63-220018-v14
                  key: root-password
            - name: REDIS_HOST
              value: "db-as63-220018-v14-0.redis-headless-as63-220018-v14.state-as63-220018-v14.svc.cluster.local"
            - name: S3_ENABLED
              value: "true"
            - name: STU_ID
              value: "220018"
            - name: STU_GROUP
              value: "AS-63"
            - name: STU_VARIANT
              value: "14"
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
            - name: backup-scripts
              mountPath: /scripts
            - name: tools
              mountPath: /tools
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: backup-storage-as63-220018-v14
          - name: backup-scripts
            configMap:
              name: backup-scripts-s3-as63-220018-v14
              defaultMode: 0755
          - name: tools
            emptyDir: {}
