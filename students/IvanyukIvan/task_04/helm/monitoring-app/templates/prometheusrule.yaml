# yamllint disable-file
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "monitoring-app.fullname" . }}-slo-alerts
  namespace: {{ .Values.namespace | default "default" }}
  labels:
    fullname: "Ivanyuk_I_A"
    group: "AS-64"
    studentId: "220041"
    email: "AS006412@g.bstu.by"
    variant: "32"
    release: monitoring
spec:
  groups:
    - name: app32-slo-rules
      rules:

        # 5xx > 2.5% за 15m
        - alert: App20High5xxErrorRate
          expr: |
            sum(rate(app32_http_request_total{status=~"5.."}[15m]))
            /
            sum(rate(app32_http_request_total[15m]))
            > 0.025
          for: 15m
          labels:
            severity: critical
          annotations:
            summary: "App32: высокий процент 5xx (>2.5% за 15m)"
            description: "Доля 5xx ошибок превысила 2.5% за последние 15 минут"

        # p95 > 350ms
        - alert: App32HighLatencyP95
          expr: |
            histogram_quantile(
              0.95,
              sum(rate(app32_http_request_duration_seconds_bucket[5m])) by (le)
            ) > 0.35
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "App32: p95 latency > 350ms"
            description: "95-й перцентиль latency выше 350ms"

        # availability < 99.5%
        - alert: App20LowAvailability
          expr: |
            1 -
            (
              sum(rate(app32_http_request_total{status=~"2..|3.."}[30d]))
              /
              sum(rate(app32_http_request_total[30d]))
            )
            > 0.005
          for: 1h
          labels:
            severity: critical
          annotations:
            summary: "App32: доступность ниже 99.5%"
            description: "SLO доступности нарушен (окно 30d)"
