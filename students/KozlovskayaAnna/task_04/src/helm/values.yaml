# Variant 8 Configuration
# SLO: 99.5%
# P95 Latency Target: 350ms
# Alert Threshold: 5xx errors > 2.5% for 15m

# Student Information
student:
  fullname: "Kozlovskaya Anna Gennadevna"
  id: "220012"
  group: "AS-63"
  variant: "8"
  slug: "as63-220012-v8"

# Application Configuration
replicaCount: 3
image:
  repository: ghcr.io/annkrq/monitoring-app
  pullPolicy: IfNotPresent
  tag: "1.0.0"

imagePullSecrets: [ ]
nameOverride: ""
fullnameOverride: ""

# Namespace
namespaceOverride: "app-as63-220012-v8"

serviceAccount:
  create: true
  annotations: { }
  name: ""

# Pod Annotations
podAnnotations: { }

# Security Context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false

# Service Configuration
service:
  type: ClusterIP
  port: 8080
  annotations: { }

# Ingress Configuration
ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
  hosts:
    - host: "app08-as63-220012-v8.local"
      paths:
        - path: /
          pathType: Prefix
  tls: [ ]

# Resource Limits
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 200m
    memory: 256Mi

# Horizontal Pod Autoscaler
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Liveness and Readiness Probes
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# Node Affinity
nodeSelector: { }
tolerations: [ ]
affinity: { }

# Prometheus Metrics Configuration
metrics:
  enabled: true
  path: /metrics
  port: 8080

  # ServiceMonitor for Prometheus Operator
  serviceMonitor:
    enabled: true
    namespace: "monitoring"
    interval: 30s
    scrapeTimeout: 10s
    labels:
      release: kube-prometheus-stack
    additionalLabels: { }

  # Prometheus Rules for SLO Alerts
  prometheusRule:
    enabled: true
    namespace: "monitoring"
    labels:
      release: kube-prometheus-stack
    additionalLabels: { }

    # SLO Thresholds for Variant 8
    slo:
      availability: 99.5
      latencyP95: 350
      errorRate5xx: 2.5

    # Alert Rules
    rules:
      - alert: HighErrorRate5xx
        expr: (sum(rate(app08_http_errors_5xx_total[15m])) / sum(rate(app08_http_requests_total[15m]))) * 100 > 2.5
        for: 15m
        labels:
          severity: critical
          student: "as63-220012-v8"
        annotations:
          summary: "High 5xx error rate detected for app08"
          description: "5xx error rate is {{ $value | humanizePercentage }} (threshold: 2.5%)"

      - alert: HighLatencyP95
        expr: histogram_quantile(0.95, sum(rate(app08_http_request_duration_seconds_bucket[5m])) by (le)) > 0.350
        for: 5m
        labels:
          severity: warning
          student: "as63-220012-v8"
        annotations:
          summary: "High P95 latency detected for app08"
          description: "P95 latency is {{ $value | humanizeDuration }} (threshold: 350ms)"

      - alert: LowAvailability
        expr: (1 - (sum(rate(app08_http_errors_5xx_total[5m])) / sum(rate(app08_http_requests_total[5m])))) * 100 < 99.5
        for: 5m
        labels:
          severity: critical
          student: "as63-220012-v8"
        annotations:
          summary: "Availability below SLO for app08"
          description: "Current availability: {{ $value | humanizePercentage }} (SLO: 99.5%)"

      - alert: ServiceDown
        expr: up{job="monitoring-app-as63-220012-v8"} == 0
        for: 2m
        labels:
          severity: critical
          student: "as63-220012-v8"
        annotations:
          summary: "Service app08 is down"
          description: "The monitoring application for variant 8 is not responding"
