apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-script
  namespace: state01
data:
  backup.sh: |
    #!/bin/bash
    set -e
    
    BACKUP_DIR="/data/backups"
    REDIS_HOST="redis.state01.svc.cluster.local"
    REDIS_PORT="6379"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="${BACKUP_DIR}/redis_backup_${TIMESTAMP}.rdb"
    
    mkdir -p "${BACKUP_DIR}"
    
    echo "Starting Redis backup at $(date)"
    
    redis-cli -h "${REDIS_HOST}" -p "${REDIS_PORT}" BGSAVE
    
    sleep 5
    
    if [ -f /data/dump.rdb ]; then
      cp /data/dump.rdb "${BACKUP_FILE}"
      echo "Backup completed: ${BACKUP_FILE}"
      
      find "${BACKUP_DIR}" -name "redis_backup_*.rdb" -mtime +7 -delete
      echo "Cleaned up backups older than 7 days"
    else
      echo "Error: dump.rdb not found"
      exit 1
    fi
    
    echo "Backup finished at $(date)"
