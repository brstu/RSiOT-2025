---
# Default values for monitoring-app
# Параметры для варианта 19

# Реплики приложения
replicaCount: 2

# Образ приложения
image:
  repository: monitoring-app
  pullPolicy: IfNotPresent
  tag: "latest"

# Namespace
namespace: monitoring-app

# Метаданные студента
student:
  id: "220024"
  fullname: "Соколова Маргарита Александровна"
  group: "АС-63"
  variant: "19"
  course: "RSIOT"
  owner: "soko1ova"
  slug: "as-63-220024-v19"

# Метрики
metrics:
  enabled: true
  prefix: "app19_"  # Префикс метрик для варианта 19
  port: 8080
  path: /metrics
  
  # SLO для варианта 19
  slo:
    availability: 99.0  # 99.0%
    latencyP95: 0.4      # 400ms
    errorRate5xx: 3      # 3% за 10 минут

# Service
service:
  type: ClusterIP
  port: 80
  targetPort: 8080
  annotations: { }
  labels:
    app: monitoring-app
    monitoring: "true"

# Ingress
ingress:
  enabled: false
  className: nginx
  annotations: { }
  hosts:
    - host: monitoring-app.local
      paths:
        - path: /
          pathType: Prefix
  tls: [ ]

# Ресурсы
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

# Probes
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# ServiceMonitor для Prometheus
serviceMonitor:
  enabled: true
  interval: 30s
  scrapeTimeout: 10s
  labels:
    release: monitoring  # Важно для kube-prometheus-stack

# PrometheusRule - алерты
prometheusRule:
  enabled: true
  labels:
    release: monitoring  # Важно для kube-prometheus-stack
  groups:
    - name: monitoring-app-alerts
      interval: 30s
      rules:
        # Alert: доступность ниже 99.0%
        - alert: LowAvailability
          expr: |
            (sum(rate(app19_http_requests_total{status!~"5.."}[10m]))
            / sum(rate(app19_http_requests_total[10m]))) * 100 < 99.0
          for: 10m
          labels:
            severity: critical
            variant: "19"
          annotations:
            summary: "Доступность ниже SLO 99.0%"
            description: >
              Текущая доступность {{ $value }}%
              (требуется ≥99.0%)

        # Alert: 5xx ошибок больше 3% за 10 минут
        - alert: HighErrorRate5xx
          expr: |
            (sum(rate(app19_http_requests_total{status=~"5.."}[10m]))
            / sum(rate(app19_http_requests_total[10m]))) * 100 > 3
          for: 10m
          labels:
            severity: warning
            variant: "19"
          annotations:
            summary: "Процент 5xx ошибок превышает 3%"
            description: >
              5xx ошибок: {{ $value }}% за последние 10 минут
              (порог >3%)

        # Alert: p95 latency превышает 400ms
        - alert: HighLatencyP95
          expr: |
            histogram_quantile(0.95,
            sum(rate(app19_http_request_duration_seconds_bucket[10m]))
            by (le)) > 0.4
          for: 10m
          labels:
            severity: warning
            variant: "19"
          annotations:
            summary: "p95 latency превышает 400ms"
            description: >
              p95 latency: {{ $value }}s (требуется ≤0.4s)

# Autoscaling
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80

# Node selector
nodeSelector: { }

# Tolerations
tolerations: [ ]

# Affinity
affinity: { }
