# ЛР04 — Наблюдаемость, Helm и GitOps

План
- Обзор: метрики/логи/трейсы (OpenTelemetry), Prometheus + Grafana, Alertmanager.
- Практика: установка мониторинга, экспонирование метрик приложения, дашборды и алерты.
- Helm‑чарт приложения и (по возможности) GitOps с Argo CD/Flux.
- Варианты (24) по SLO/порогам и префиксам метрик.
- Материалы и раздел «отладка».

Необходимые знания и ПО
- Кластер Kubernetes; Helm 3; доступ к установке kube‑prometheus‑stack или аналогов; базовые знания PromQL.

Краткая теория
- Observability = логирование, метрики, трассировка. На старте достаточно метрик и алертов по SLO.
- kube‑prometheus‑stack разворачивает Prometheus/Alertmanager/Grafana и экспортеры. Приложению нужен HTTP endpoint `/metrics`.
- Helm параметризует манифесты; GitOps фиксирует желаемое состояние в Git и синхронизирует кластер.

Практика
1) Установка мониторинга
   - Установите kube‑prometheus‑stack в namespace `monitoring` (helm repo add / install).
2) Метрики приложения
   - Добавьте клиент Prometheus в приложение (ЛР01) и endpoint `/metrics` с префиксом метрик (см. вариант).
   - Создайте ServiceMonitor/PodMonitor для сбора.
3) Дашборды и алерты
   - 2–3 дашборда: доступность, задержка p95, ошибки 5xx.
   - 1–2 алерта по SLO (доступность/ошибки/latency).
4) Helm‑чарт
   - Values: namespace, порт, ресурсы, ingressClass, реплики, префикс метрик.
   - Templates: Deployment, Service, Ingress, ServiceMonitor, PrometheusRule.
5) GitOps (опционально)
   - Argo CD/Flux для авто‑синхронизации чарта.

## Быстрый старт

Минимальные шаги (minikube + kube‑prometheus‑stack):
1. Добавьте репозиторий: `helm repo add prometheus-community https://prometheus-community.github.io/helm-charts` и `helm repo update`.
2. Установите стек: `helm install monitoring prometheus-community/kube-prometheus-stack -n monitoring --create-namespace`.
3. Добавьте в приложение endpoint `/metrics` (счетчик запросов + гистограмма latency).
4. Создайте `ServiceMonitor` с selector по label приложения и примените.
5. Пробросьте порт Prometheus или Grafana: `kubectl port-forward svc/monitoring-grafana 3000:80 -n monitoring`.
6. Убедитесь в наличии ваших метрик (`rate(http_requests_total[1m])`) и гистограммы latency.
7. Создайте простое правило алерта (PrometheusRule) по доступности или повышенной ошибочности и убедитесь, что оно становится Active/Firing.

Критерии приёмки
- Метрики собираются; есть дашборды; хотя бы один сработавший/симулированный alert.
- Helm‑чарт деплоится; (опционально) GitOps синхронизирует релиз.

Формат сдачи
- PR в основную ветку; ревьювер https://github.com/andreiNiasiuk. README: схема мониторинга, скриншоты, параметры чарта/GitOps.

См. варианты в файле `Варианты.md`.

Материалы для чтения
- kube‑prometheus‑stack: https://github.com/prometheus-operator/kube-prometheus
- Prometheus Docs: https://prometheus.io/docs/introduction/overview/
- Grafana: https://grafana.com/docs/
- OpenTelemetry: https://opentelemetry.io/
- Argo CD: https://argo-cd.readthedocs.io/
- Flux: https://fluxcd.io/

Отладка и типичные ошибки
- Метрики не собираются: проверьте ServiceMonitor/PodMonitor и label selectors, доступность `/metrics`.
- Алерты не срабатывают: проверьте PrometheusRule и связь с Alertmanager.
- Helm‑релиз «битый»: `helm lint`, проверка values, конфликт имен/namespace.
- GitOps не применяет: проверьте доступ к репо, health‑статус приложения.
