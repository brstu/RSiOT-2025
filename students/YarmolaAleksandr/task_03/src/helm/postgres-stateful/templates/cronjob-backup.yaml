{{- if .Values.backup.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Values.backup.name }}
  namespace: {{ .Values.namespace.name }}
  labels:
    app: {{ .Values.labels.app }}
    component: backup
    org.bstu.course: {{ .Values.labels.course | quote }}
    org.bstu.student.id: {{ .Values.student.id | quote }}
    org.bstu.group: {{ .Values.student.groupLatin | quote }}
    org.bstu.variant: {{ .Values.student.variant | quote }}
    org.bstu.owner: {{ .Values.student.owner | quote }}
spec:
  schedule: {{ .Values.backup.schedule | quote }}
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: {{ .Values.labels.app }}
            component: backup
            org.bstu.student.id: {{ .Values.student.id | quote }}
        spec:
          restartPolicy: OnFailure
          containers:
            - name: backup
              image: {{ .Values.backup.image.repository }}:{{ .Values.backup.image.tag }}
              command:
                - /bin/bash
                - /scripts/backup.sh
              envFrom:
                - secretRef:
                    name: db-postgres-secret
              env:
                - name: POSTGRES_HOST
                  value: {{ .Values.service.name }}
                - name: POSTGRES_PORT
                  value: {{ .Values.postgres.port | quote }}
                - name: STU_ID
                  value: {{ .Values.student.id | quote }}
                - name: STU_GROUP
                  value: {{ .Values.student.group | quote }}
                - name: STU_VARIANT
                  value: {{ .Values.student.variant | quote }}
              volumeMounts:
                - name: backups
                  mountPath: /backups
                - name: scripts
                  mountPath: /scripts
              resources:
                {{- toYaml .Values.backup.resources | nindent 16 }}
          volumes:
            - name: backups
              persistentVolumeClaim:
                claimName: {{ .Values.storage.backup.name }}
            - name: scripts
              configMap:
                name: {{ .Values.scripts.name }}
                defaultMode: 0755
{{- end }}
