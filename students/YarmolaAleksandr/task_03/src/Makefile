.PHONY: help deploy test-data backup restore clean status logs helm-install helm-upgrade helm-uninstall helm-lint helm-template

NAMESPACE := state-as63-220028-v23
STATEFULSET := db-postgres-as63-220028-v23
SERVICE := db-postgres-headless
HELM_RELEASE := postgres-lab03
HELM_CHART := helm/postgres-stateful

help:
	@echo "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 03 - PostgreSQL StatefulSet"
	@echo "================================================"
	@echo ""
	@echo "–ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã (kubectl):"
	@echo "  make deploy      - –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã"
	@echo "  make test-data   - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ"
	@echo "  make status      - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤"
	@echo "  make logs        - –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ PostgreSQL"
	@echo "  make backup-now  - –ó–∞–ø—É—Å—Ç–∏—Ç—å backup –≤—Ä—É—á–Ω—É—é"
	@echo "  make restore     - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ backup"
	@echo "  make clean       - –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã"
	@echo ""
	@echo "Helm –∫–æ–º–∞–Ω–¥—ã (–ë–æ–Ω—É—Å +5 –±–∞–ª–ª–æ–≤):"
	@echo "  make helm-install   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ Helm"
	@echo "  make helm-upgrade   - –û–±–Ω–æ–≤–∏—Ç—å Helm release"
	@echo "  make helm-uninstall - –£–¥–∞–ª–∏—Ç—å Helm release"
	@echo "  make helm-lint      - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Helm chart"
	@echo "  make helm-template  - –í—ã–≤–µ—Å—Ç–∏ —à–∞–±–ª–æ–Ω—ã Helm"
	@echo "  make helm-status    - –°—Ç–∞—Ç—É—Å Helm release"
	@echo ""

deploy:
	@echo "=== –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ PostgreSQL StatefulSet ==="
	kubectl apply -f k8s/namespace.yaml
	kubectl apply -f k8s/storageclass.yaml
	kubectl apply -f k8s/secret.yaml
	kubectl apply -f k8s/backup-pvc.yaml
	kubectl apply -f k8s/service.yaml
	kubectl apply -f k8s/statefulset.yaml
	kubectl apply -f k8s/configmap-scripts.yaml
	kubectl apply -f k8s/cronjob-backup.yaml
	@echo ""
	@echo "‚úÖ –ú–∞–Ω–∏—Ñ–µ—Å—Ç—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã. –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–æ–≤..."
	kubectl wait --for=condition=ready pod -l app=postgres -n $(NAMESPACE) --timeout=120s
	@echo "‚úÖ PostgreSQL –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!"

status:
	@echo "=== –°—Ç–∞—Ç—É—Å —Ä–µ—Å—É—Ä—Å–æ–≤ ==="
	@echo "\nüì¶ Namespace:"
	kubectl get namespace $(NAMESPACE)
	@echo "\nüóÑÔ∏è  StatefulSet:"
	kubectl get statefulset -n $(NAMESPACE)
	@echo "\nüîå Service:"
	kubectl get svc -n $(NAMESPACE)
	@echo "\nüìÅ PVC:"
	kubectl get pvc -n $(NAMESPACE)
	@echo "\nüîí Secret:"
	kubectl get secret -n $(NAMESPACE)
	@echo "\n‚è∞ CronJob:"
	kubectl get cronjob -n $(NAMESPACE)
	@echo "\nüìä Pods:"
	kubectl get pods -n $(NAMESPACE) -o wide

logs:
	@echo "=== –õ–æ–≥–∏ PostgreSQL (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫) ==="
	kubectl logs -n $(NAMESPACE) -l app=postgres --tail=50 --follow=false

logs-follow:
	@echo "=== –õ–æ–≥–∏ PostgreSQL (—Å–ª–µ–¥–∏—Ç—å) ==="
	kubectl logs -n $(NAMESPACE) -l app=postgres --tail=50 --follow

test-data:
	@echo "=== –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö ==="
	@POD=$$(kubectl get pod -n $(NAMESPACE) -l app=postgres -o jsonpath='{.items[0].metadata.name}'); \
	kubectl exec -n $(NAMESPACE) $$POD -- psql -U admin -d testdb -c "\
	CREATE TABLE IF NOT EXISTS students ( \
	  id SERIAL PRIMARY KEY, \
	  student_id VARCHAR(10), \
	  fullname VARCHAR(100), \
	  university_group VARCHAR(20), \
	  variant INT, \
	  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP \
	);" && \
	kubectl exec -n $(NAMESPACE) $$POD -- psql -U admin -d testdb -c "\
	INSERT INTO students (student_id, fullname, university_group, variant) \
	VALUES ('220028', '–Ø—Ä–º–æ–ª–∞ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –û–ª–µ–≥–æ–≤–∏—á', '–ê–°-63', 23) \
	ON CONFLICT DO NOTHING;" && \
	echo "‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã!" && \
	echo "\n–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–ª–∏—Ü—ã students:" && \
	kubectl exec -n $(NAMESPACE) $$POD -- psql -U admin -d testdb -c "SELECT * FROM students;"

check-data:
	@echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö ==="
	@POD=$$(kubectl get pod -n $(NAMESPACE) -l app=postgres -o jsonpath='{.items[0].metadata.name}'); \
	kubectl exec -n $(NAMESPACE) $$POD -- psql -U admin -d testdb -c "SELECT * FROM students;"

backup-now:
	@echo "=== –ó–∞–ø—É—Å–∫ backup –≤—Ä—É—á–Ω—É—é ==="
	kubectl create job --from=cronjob/backup-postgres-as63-220028-v23 \
	  backup-manual-$$(date +%Y%m%d-%H%M%S) \
	  -n $(NAMESPACE)
	@echo "‚úÖ Job —Å–æ–∑–¥–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: kubectl get jobs -n $(NAMESPACE)"
	@echo "–õ–æ–≥–∏: kubectl logs -n $(NAMESPACE) -l app=postgres-backup --tail=50"

backup-logs:
	@echo "=== –õ–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ backup ==="
	@POD=$$(kubectl get pods -n $(NAMESPACE) -l app=postgres-backup --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}' 2>/dev/null); \
	if [ -n "$$POD" ]; then \
	  kubectl logs -n $(NAMESPACE) $$POD; \
	else \
	  echo "Backup jobs –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"; \
	fi

restore:
	@echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —É–¥–∞–ª–∏—Ç —Ç–µ–∫—É—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö!"
	@echo "–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Ç–º–µ–Ω—ã, Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
	@read confirm
	@echo "=== –ó–∞–ø—É—Å–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ==="
	kubectl delete job restore-postgres-as63-220028-v23 -n $(NAMESPACE) --ignore-not-found
	kubectl apply -f k8s/job-restore.yaml
	@echo "‚úÖ Restore Job —Å–æ–∑–¥–∞–Ω"
	@echo "–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º: kubectl logs -n $(NAMESPACE) -l app=postgres-restore --follow"

restore-logs:
	@echo "=== –õ–æ–≥–∏ restore ==="
	@POD=$$(kubectl get pods -n $(NAMESPACE) -l app=postgres-restore -o jsonpath='{.items[0].metadata.name}' 2>/dev/null); \
	if [ -n "$$POD" ]; then \
	  kubectl logs -n $(NAMESPACE) $$POD --follow; \
	else \
	  echo "Restore job –Ω–µ –Ω–∞–π–¥–µ–Ω"; \
	fi

delete-data:
	@echo "=== –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö ==="
	@POD=$$(kubectl get pod -n $(NAMESPACE) -l app=postgres -o jsonpath='{.items[0].metadata.name}'); \
	kubectl exec -n $(NAMESPACE) $$POD -- psql -U admin -d testdb -c "DROP TABLE IF EXISTS students CASCADE;" && \
	echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ students —É–¥–∞–ª–µ–Ω–∞"

restart-pod:
	@echo "=== –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PostgreSQL pod ==="
	kubectl delete pod -n $(NAMESPACE) -l app=postgres
	@echo "–û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–¥–∞..."
	kubectl wait --for=condition=ready pod -l app=postgres -n $(NAMESPACE) --timeout=120s
	@echo "‚úÖ Pod –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"

clean:
	@echo "=== –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ ==="
	kubectl delete namespace $(NAMESPACE) --ignore-not-found
	kubectl delete storageclass premium-storage --ignore-not-found
	@echo "‚úÖ –í—Å–µ —Ä–µ—Å—É—Ä—Å—ã —É–¥–∞–ª–µ–Ω—ã"

shell:
	@echo "=== –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL ==="
	@POD=$$(kubectl get pod -n $(NAMESPACE) -l app=postgres -o jsonpath='{.items[0].metadata.name}'); \
	kubectl exec -it -n $(NAMESPACE) $$POD -- psql -U admin -d testdb

# ========================================
# Helm –∫–æ–º–∞–Ω–¥—ã (–ë–æ–Ω—É—Å +5 –±–∞–ª–ª–æ–≤)
# ========================================

helm-lint:
	@echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ Helm chart ==="
	helm lint $(HELM_CHART)
	@echo "‚úÖ Helm chart –≤–∞–ª–∏–¥–µ–Ω!"

helm-template:
	@echo "=== –í—ã–≤–æ–¥ —à–∞–±–ª–æ–Ω–æ–≤ Helm ==="
	helm template $(HELM_RELEASE) $(HELM_CHART)

helm-install:
	@echo "=== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ Helm ==="
	helm install $(HELM_RELEASE) $(HELM_CHART) --create-namespace
	@echo ""
	@echo "‚úÖ Helm release —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–æ–≤..."
	kubectl wait --for=condition=ready pod -l app=postgres -n $(NAMESPACE) --timeout=120s
	@echo "‚úÖ PostgreSQL –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!"

helm-upgrade:
	@echo "=== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Helm release ==="
	helm upgrade $(HELM_RELEASE) $(HELM_CHART)
	@echo "‚úÖ Helm release –æ–±–Ω–æ–≤–ª–µ–Ω!"

helm-uninstall:
	@echo "=== –£–¥–∞–ª–µ–Ω–∏–µ Helm release ==="
	helm uninstall $(HELM_RELEASE) -n $(NAMESPACE)
	kubectl delete storageclass premium-storage --ignore-not-found
	@echo "‚úÖ Helm release —É–¥–∞–ª–µ–Ω!"

helm-status:
	@echo "=== –°—Ç–∞—Ç—É—Å Helm release ==="
	helm status $(HELM_RELEASE) -n $(NAMESPACE)
	@echo ""
	@echo "=== –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ ==="
	kubectl get all,pvc,secret,configmap,cronjob -n $(NAMESPACE)

helm-values:
	@echo "=== –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ values ==="
	helm get values $(HELM_RELEASE) -n $(NAMESPACE)

helm-history:
	@echo "=== –ò—Å—Ç–æ—Ä–∏—è —Ä–µ–ª–∏–∑–æ–≤ ==="
	helm history $(HELM_RELEASE) -n $(NAMESPACE)
