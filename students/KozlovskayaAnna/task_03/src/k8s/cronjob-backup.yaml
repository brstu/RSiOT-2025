---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-as63-220012-v8
  namespace: state-as63-220012-v8
  labels:
    app.kubernetes.io/name: redis-backup
    app.kubernetes.io/instance: backup-as63-220012-v8
    app.kubernetes.io/part-of: redis-stateful
    org.bstu.student.fullname: "РљРѕР·Р»РѕРІСЃРєР°СЏ РђРЅРЅР° Р“РµРЅРЅР°РґСЊРµРІРЅР°"
    org.bstu.student.id: "220012"
    org.bstu.group: "РђРЎ-63"
    org.bstu.variant: "8"
    org.bstu.course: RSIOT
    org.bstu.owner: annkrq
    org.bstu.student.slug: as63-220012-v8
spec:
  schedule: "*/5 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app.kubernetes.io/name: redis-backup
            app.kubernetes.io/instance: backup-as63-220012-v8
            app.kubernetes.io/part-of: redis-stateful
            org.bstu.student.fullname: "РљРѕР·Р»РѕРІСЃРєР°СЏ РђРЅРЅР° Р“РµРЅРЅР°РґСЊРµРІРЅР°"
            org.bstu.student.id: "220012"
            org.bstu.group: "РђРЎ-63"
            org.bstu.variant: "8"
            org.bstu.course: RSIOT
            org.bstu.owner: annkrq
            org.bstu.student.slug: as63-220012-v8
        spec:
          restartPolicy: OnFailure
          containers:
            - name: redis-backup
              image: redis:7.2-alpine
              imagePullPolicy: IfNotPresent
              env:
                - name: REDIS_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: db-as63-220012-v8-secret
                      key: REDIS_PASSWORD
                - name: STU_ID
                  value: "220012"
                - name: STU_GROUP
                  value: "РђРЎ-63"
                - name: STU_VARIANT
                  value: "8"
                - name: POD_NAMESPACE
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.namespace
                - name: REDIS_HOST
                  value: "db-as63-220012-v8-0.db-as63-220012-v8.state-as63-220012-v8.svc.cluster.local"
              command: ["/bin/sh", "/opt/scripts/backup.sh"]
              volumeMounts:
                - name: backup-storage
                  mountPath: /backup
                - name: scripts
                  mountPath: /opt/scripts
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: backup-as63-220012-v8-pvc
            - name: scripts
              configMap:
                name: db-as63-220012-v8-scripts
                defaultMode: 0755
